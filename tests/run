#!/bin/bash
set -e

if [[ ! -f /.dockerenv ]]; then
    echo "Tests should be run inside a Docker container. Use bin/run-tests script from the root of the project."
    exit -1
fi

LANG_PROPERTIES_FILE=lang.properties

prefered_lang=$1

for lang in *; do
    [[ ! -d $lang ]] && continue

    properties=$lang/$LANG_PROPERTIES_FILE
    [[ ! -f $properties ]] && continue

    [[ $prefered_lang != "" && $prefered_lang != $lang ]] && continue

    source $properties
    for VERSION in $VERSIONS; do
        source $properties

        echo "--- $NAME ---"
        cd $lang

        $COMPILE_CMD
        echo "world" | bash -c "$RUN_CMD"

        rm $(ls . | grep -v $SOURCE_FILE | grep -v $LANG_PROPERTIES_FILE) &> /dev/null || true

        cd ..

        echo
    done
done